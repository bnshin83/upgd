# UPGD Development Log - December 20, 2025

## Summary

Added ablation study infrastructure for investigating the effect of non-gated layer scaling and high-utility parameter freezing in UPGD.

---

## 1. Paper Body Updates (`paper_body.md`)

### Enhanced Utility Distribution Analysis Section

Added detailed explanation of Output-Only gating mechanism:

- **Network Architecture**: Input � linear_1 (300) � ReLU � linear_2 (150) � ReLU � linear_3 (output) � loss

- **Layer-Selective Gating Equations**:
  - Gated layers: `� � � - �(g + õ)(1 - s)`
  - Non-gated layers: `� � � - �(g + õ) � 0.5`

- **Parameter Counts Table** (Table 2):
  | Dataset | linear_1 | linear_2 | linear_3 | Total |
  |---------|----------|----------|----------|-------|
  | MNIST | 235,500 | 45,150 | 1,510 | 282,160 |
  | EMNIST | 235,500 | 45,150 | 7,097 | 287,747 |
  | CIFAR-10 | 921,900 | 45,150 | 1,510 | 968,560 |
  | Mini-ImageNet | 614,700 | 45,150 | 15,100 | 674,950 |

- **Key Insight**: Output-only gating applies utility-based protection to only **0.16-2.5%** of parameters (output head), yet achieves up to 104% improvement over S&P.

---

## 2. Optimizer Updates (`core/optim/weight_upgd/first_order_layerselective.py`)

### New Parameters Added

```python
def __init__(self, params, lr=1e-5, weight_decay=0.0, beta_utility=0.0, sigma=1.0,
             gating_mode='full', non_gated_scale=0.5,
             freeze_high_utility=False, freeze_threshold=0.52):
```

### New `gating_mode` Option

- `'output_frozen'`: Freeze output layer completely, hidden layers get `non_gated_scale`

### New Parameters

| Parameter | Default | Description |
|-----------|---------|-------------|
| `non_gated_scale` | 0.5 | Scaling factor for non-gated layers (0.0=frozen, 1.0=full SGD) |
| `freeze_high_utility` | False | If True, freeze params where `scaled_utility >= freeze_threshold` |
| `freeze_threshold` | 0.52 | Threshold for freezing high-utility parameters |

### Meaningful `non_gated_scale` Values

| Value | Interpretation |
|-------|----------------|
| 0.0 | Freeze non-gated layers completely |
| 0.27 | Match max protection level (1 - sigmoid(1) H 0.27) |
| 0.5 | Neutral utility level (1 - sigmoid(0) = 0.5) [default] |
| 0.73 | Match min protection level (sigmoid(1) H 0.73) |
| 1.0 | Full SGD updates (no scaling) |

---

## 3. New Learner Classes (`core/learner/weight_upgd.py`)

### Non-Gated Scale Ablation Learners

```python
class UPGDOutputOnlyScale0Learner      # scale=0.0 (hidden frozen)
class UPGDOutputOnlyScale027Learner    # scale=0.27 (max protection)
class UPGDOutputOnlyScale05Learner     # scale=0.5 (neutral, default)
class UPGDOutputOnlyScale073Learner    # scale=0.73 (min protection)
class UPGDOutputOnlyScale1Learner      # scale=1.0 (full SGD)
```

### Output Frozen Learner

```python
class UPGDOutputFrozenLearner
# Output layer completely frozen, hidden layers trainable with non_gated_scale=1.0
```

### Freeze High-Utility Learner

```python
class UPGDFreezeHighUtilityLearner     # Base class with configurable threshold
class UPGDFreezeHighUtility52Learner   # Freeze params with s >= 0.52
```

---

## 4. Registry Updates (`core/utils.py`)

Added new learner registrations:

```python
# Output-only with non-gated scale ablation
"upgd_fo_global_outputonly_scale0": UPGDOutputOnlyScale0Learner,
"upgd_fo_global_outputonly_scale27": UPGDOutputOnlyScale027Learner,
"upgd_fo_global_outputonly_scale50": UPGDOutputOnlyScale05Learner,
"upgd_fo_global_outputonly_scale73": UPGDOutputOnlyScale073Learner,
"upgd_fo_global_outputonly_scale1": UPGDOutputOnlyScale1Learner,

# Output frozen (output layer completely frozen)
"upgd_fo_global_outputfrozen": UPGDOutputFrozenLearner,

# Freeze high-utility parameters (scaled_utility >= threshold)
"upgd_fo_global_freezehigh52": UPGDFreezeHighUtility52Learner,
```

---

## 5. SLURM Job (`upgd_emnist_scale_ablation.sh`)

Created ablation study SLURM script that runs 7 experiments:

### Experiments

1. **scale=0.0** - Hidden frozen, output gated
2. **scale=0.27** - Hidden max protection, output gated
3. **scale=0.5** - Hidden neutral (default), output gated
4. **scale=0.73** - Hidden min protection, output gated
5. **scale=1.0** - Hidden full SGD, output gated
6. **output_frozen** - Output layer completely frozen, hidden full SGD
7. **freezehigh52** - All layers gated, but params with se0.52 frozen

### Parameters

- Dataset: EMNIST (47 classes)
- lr=0.01, sigma=0.001, beta=0.9, wd=0.0
- seed=0, n_samples=1,000,000

### To Run

```bash
sbatch upgd_emnist_scale_ablation.sh
```

---

## 6. Experiment Definition (`experiments/ablation_nongated_scale.py`)

Created experiment file for grid search ablation (alternative to SLURM script).

---

## Key Research Questions

1. **What is the optimal scaling for hidden layers in output-only gating?**
   - Does 0.5 (neutral) perform best, or would higher plasticity (0.73, 1.0) help?

2. **Should output layer be frozen instead of gated?**
   - Compare `output_frozen` vs `output_only` (gated)

3. **Should high-utility parameters be completely frozen?**
   - Compare soft gating `(1-s)` vs hard freeze at threshold

---

## Files Modified

| File | Changes |
|------|---------|
| `paper_body.md` | Added detailed Output-Only explanation with parameter tables |
| `core/optim/weight_upgd/first_order_layerselective.py` | Added `non_gated_scale`, `freeze_high_utility`, `freeze_threshold`, `output_frozen` mode |
| `core/learner/weight_upgd.py` | Added 7 new learner classes |
| `core/utils.py` | Registered 7 new learners |
| `upgd_emnist_scale_ablation.sh` | Created SLURM job for ablation study |
| `experiments/ablation_nongated_scale.py` | Created experiment definition |
| `slurm_ablation/*.sh` | Created 7 separate SLURM scripts for parallel execution |

---

## 7. SLURM Jobs Submitted

Split into 7 separate SLURM scripts in `slurm_ablation/` for parallel execution:

| Job ID | Script | Experiment |
|--------|--------|------------|
| 5427194 | `ablation_scale0.sh` | scale=0.0 (hidden frozen) |
| 5427195 | `ablation_scale27.sh` | scale=0.27 (max protection) |
| 5427196 | `ablation_scale50.sh` | scale=0.5 (neutral) |
| 5427197 | `ablation_scale73.sh` | scale=0.73 (min protection) |
| 5427198 | `ablation_scale1.sh` | scale=1.0 (full SGD) |
| 5427199 | `ablation_outputfrozen.sh` | output frozen |
| 5427200 | `ablation_freezehigh52.sh` | freeze high utility (s>=0.52) |

---

## 8. Job Failure - HesScale Module Missing

**Problem:** All 7 jobs failed with the following error:

```
ModuleNotFoundError: No module named 'hesscale'
```

**Root Cause:** The HesScale git submodule was not initialized. The import chain is:
1. `run_stats_with_curvature.py` imports `core.utils`
2. `core.utils` imports `core.network.fcn_leakyrelu`
3. `fcn_leakyrelu` imports `.gate`
4. `gate.py` imports `from hesscale.core.hesscale_base import BaseModuleHesScale`

**Fix:** Initialize and install the HesScale submodule:
```bash
git submodule update --init --recursive
source .upgd/bin/activate
pip install -e HesScale/.
```

Then resubmit jobs:
```bash
bash slurm_ablation/submit_all.sh
```

---

## 9. Jobs Resubmitted - Second Failure (numpy version conflict)

Jobs 5430296-5430302 failed immediately with:
```
TypeError: expected np.ndarray (got numpy.ndarray)
```

**Root Cause:** Corrupted numpy installation - pip showed 1.26.4 but Python imported 2.3.5 (breaking compatibility with torchvision).

**Fix:**
```bash
source .upgd/bin/activate
pip uninstall numpy -y
pip install "numpy<2.0"
```

This reinstalled numpy 1.26.4 properly and removed the hidden 2.3.5 version.

---

## 10. Jobs Resubmitted (Final)

| Job ID | Script | Experiment |
|--------|--------|------------|
| 5430314 | `ablation_scale0.sh` | scale=0.0 (hidden frozen) |
| 5430315 | `ablation_scale27.sh` | scale=0.27 (max protection) |
| 5430316 | `ablation_scale50.sh` | scale=0.5 (neutral) |
| 5430317 | `ablation_scale73.sh` | scale=0.73 (min protection) |
| 5430318 | `ablation_scale1.sh` | scale=1.0 (full SGD) |
| 5430319 | `ablation_outputfrozen.sh` | output frozen |
| 5430320 | `ablation_freezehigh52.sh` | freeze high utility (s>=0.52) |

**Status:** All jobs pending in queue.

---

## 11. Note on Numpy Fix Compatibility

The numpy fix (downgrading from 2.3.5 to 1.26.4) does **not** affect other existing SLURM scripts:

- `upgd_cifar10_*.sh`
- `upgd_emnist_*.sh`
- `upgd_imnist_*.sh`
- `upgd_mini_imagenet_*.sh`
- `snp_*.sh`

**Reason:** These scripts ran successfully on Dec 17-18 with numpy 1.26.4. The fix restores the environment to that working state. Already completed runs are unaffected (results saved in JSON/wandb).

**Prevention:** To avoid future numpy 2.x upgrades, consider pinning in requirements:
```
numpy<2.0
```
