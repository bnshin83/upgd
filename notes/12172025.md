# UPGD Bug Fixes - December 17, 2025

## Summary

Fixed missing utility histogram data in `get_utility_stats()` methods for two optimizer classes. This ensures future experiments will save utility histogram data to JSON files, eliminating the need for WandB extraction.

---

## 1. Bug: Missing Histogram Data in `get_utility_stats()`

### Problem

Two optimizer classes computed 9-bin utility histogram statistics in their `step()` method but did NOT return them in `get_utility_stats()`:

1. **`FirstOrderGlobalUPGDClampedSymmetric`** (`first_order_clamped_symmetric.py`)
   - Used by: `upgd_fo_global_clamped_44_56`, `upgd_fo_global_clamped_48_52`

2. **`FirstOrderGlobalUPGDLayerSelective`** (`first_order_layerselective.py`)
   - Used by: `upgd_fo_global_outputonly`, `upgd_fo_global_hiddenonly`, `upgd_fo_global_hiddenandoutput`

### Impact

- Utility histogram data was logged to WandB during training (via `run_stats_with_curvature.py`)
- BUT was NOT saved to local JSON files
- Required WandB API extraction for plotting utility histograms

---

## 2. Fixes Applied

### Fix 1: `core/optim/weight_upgd/first_order_clamped_symmetric.py`

**Location:** `get_utility_stats()` method (lines 190-212)

**Added:**
```python
# Add utility histogram statistics (9 bins)
if hasattr(self, 'utility_hist_0_20'):
    stats.update({
        'utility/hist_0_20': self.utility_hist_0_20,
        'utility/hist_20_40': self.utility_hist_20_40,
        'utility/hist_40_44': self.utility_hist_40_44,
        'utility/hist_44_48': self.utility_hist_44_48,
        'utility/hist_48_52': self.utility_hist_48_52,
        'utility/hist_52_56': self.utility_hist_52_56,
        'utility/hist_56_60': self.utility_hist_56_60,
        'utility/hist_60_80': self.utility_hist_60_80,
        'utility/hist_80_100': self.utility_hist_80_100,
        'utility/hist_0_20_pct': self.utility_hist_0_20_pct,
        'utility/hist_20_40_pct': self.utility_hist_20_40_pct,
        'utility/hist_40_44_pct': self.utility_hist_40_44_pct,
        'utility/hist_44_48_pct': self.utility_hist_44_48_pct,
        'utility/hist_48_52_pct': self.utility_hist_48_52_pct,
        'utility/hist_52_56_pct': self.utility_hist_52_56_pct,
        'utility/hist_56_60_pct': self.utility_hist_56_60_pct,
        'utility/hist_60_80_pct': self.utility_hist_60_80_pct,
        'utility/hist_80_100_pct': self.utility_hist_80_100_pct,
        'utility/total_params': self.utility_total_params,
    })
```

### Fix 2: `core/optim/weight_upgd/first_order_layerselective.py`

**Location:** `get_utility_stats()` method (lines 258-280)

**Added:** Same 9-bin histogram statistics as above.

---

## 3. Affected Experiments

### Already Completed (JSON missing histogram data)

| Dataset | Experiment | JSON Status | WandB Status |
|---------|------------|-------------|--------------|
| EMNIST | `upgd_fo_global_clamped_44_56` | Missing histogram | Has histogram |
| EMNIST | `upgd_fo_global_clamped_48_52` | Missing histogram | Has histogram |

### Future Experiments (Will have histogram data in JSON)

All experiments using:
- `upgd_fo_global_clamped_44_56`
- `upgd_fo_global_clamped_48_52`
- `upgd_fo_global_outputonly`
- `upgd_fo_global_hiddenonly`
- `upgd_fo_global_hiddenandoutput`

---

## 4. Data Availability Summary for EMNIST Clamped Experiments

### Training Metrics (in JSON) - Ready for Plotting

| Metric | Points | Available |
|--------|--------|-----------|
| `accuracy_per_step` | 1,000,000 | Yes |
| `losses_per_step` | 1,000,000 | Yes |
| `plasticity_per_step` | 1,000,000 | Yes |
| `n_dead_units_per_step` | 1,000,000 | Yes |
| `weight_l2_per_step` | 1,000,000 | Yes |
| `weight_l1_per_step` | 1,000,000 | Yes |
| `grad_l2_per_step` | 1,000,000 | Yes |

### Utility Histograms - Requires WandB Extraction

| Data | In JSON | In WandB |
|------|---------|----------|
| `utility_histogram_per_step` | No | Yes |
| 9-bin distribution | No | Yes |

---

## 5. How to Plot

### Training Metrics (works now)

```bash
cd /scratch/gautschi/shin283/upgd_plots
conda activate plasticity
python scripts/plot_training_metrics.py emnist
```

### Utility Histograms (requires WandB extraction first)

```bash
# Step 1: Extract from WandB
python scripts/extract_utility_histograms_local.py emnist

# Step 2: Plot
python scripts/plot_utility_histograms.py emnist
```

---

## 6. Verification

After fixing, verified that `first_order_clamped.py` (for clamped052) already had correct implementation - it served as the reference for the fixes.

### Optimizer Histogram Support Status

| Optimizer | `get_utility_stats()` returns histogram | Status |
|-----------|----------------------------------------|--------|
| `FirstOrderGlobalUPGD` | Yes | OK |
| `FirstOrderGlobalUPGDClamped052` | Yes | OK |
| `FirstOrderGlobalUPGDClampedSymmetric` | Yes | **FIXED** |
| `FirstOrderGlobalUPGDLayerSelective` | Yes | **FIXED** |

---

---

## 7. Verification Test

Ran a quick 1000-sample test to verify the fix works:

```bash
# Test with seed 99, 1000 samples
python3 core/run/run_stats_with_curvature.py \
    --task label_permuted_emnist_stats \
    --learner upgd_fo_global_clamped_48_52 \
    --seed 99 --n_samples 1000 ...
```

**Result:** JSON file now contains:

```
utility_histogram_per_step: dict with 12 keys
  steps: list[100]           # Logged every 10 steps
  hist_0_20_pct: list[100]
  hist_20_40_pct: list[100]
  hist_40_44_pct: list[100]
  hist_44_48_pct: list[100]
  hist_48_52_pct: list[100]
  hist_52_56_pct: list[100]
  hist_56_60_pct: list[100]
  hist_60_80_pct: list[100]
  hist_80_100_pct: list[100]
  global_max: list[100]
  total_params: 287747

layer_utility_histogram_per_step: dict with 3 keys
  (per-layer data for linear_1, linear_2, linear_3)
```

---

## Document History

- 2025-12-17: Created, documented histogram data fixes for clamped symmetric and layer-selective optimizers
- 2025-12-17: Added verification test results confirming the fix works
